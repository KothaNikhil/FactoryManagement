<UserControl x:Class="FactoryManagement.Views.DashboardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <Grid Margin="20">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

        <!-- Summary Cards with Modern Design -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Item Transaction Cards -->
            <UniformGrid Grid.Row="0" Rows="1" Columns="4" Margin="0,0,0,12">
                <!-- Total Purchases Card -->
                <Border Background="#4a90c8" CornerRadius="8" Padding="16" Margin="0,0,12,0">
                    <Border.Effect>
                        <DropShadowEffect Color="Black" Opacity="0.3" ShadowDepth="2" BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="ðŸ›’" FontSize="32" VerticalAlignment="Center" Margin="0,0,12,0"/>
                        
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Total Purchases" Foreground="#ADD8E6" FontSize="11" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TotalPurchases, StringFormat='â‚¹{0:N2}'}" 
                                       Foreground="White" FontSize="20" FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Total Sales Card -->
                <Border Background="#3d8b5f" CornerRadius="8" Padding="16" Margin="0,0,12,0">
                    <Border.Effect>
                        <DropShadowEffect Color="Black" Opacity="0.3" ShadowDepth="2" BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="ðŸ’°" FontSize="32" VerticalAlignment="Center" Margin="0,0,12,0"/>
                        
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Total Sales" Foreground="#90EE90" FontSize="11" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TotalSales, StringFormat='â‚¹{0:N2}'}" 
                                       Foreground="White" FontSize="20" FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Total Wastage Card -->
                <Border Background="#b85450" CornerRadius="8" Padding="16" Margin="0,0,12,0">
                    <Border.Effect>
                        <DropShadowEffect Color="Black" Opacity="0.3" ShadowDepth="2" BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="âš ï¸" FontSize="32" VerticalAlignment="Center" Margin="0,0,12,0"/>
                        
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Total Wastage" Foreground="#FFB6C1" FontSize="11" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TotalWastage, StringFormat='â‚¹{0:N2}'}" 
                                       Foreground="White" FontSize="20" FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Transaction Count Card -->
                <Border Background="#d9a05b" CornerRadius="8" Padding="16" Margin="0">
                    <Border.Effect>
                        <DropShadowEffect Color="Black" Opacity="0.3" ShadowDepth="2" BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="ðŸ“Š" FontSize="32" VerticalAlignment="Center" Margin="0,0,12,0"/>
                        
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Total Transactions" Foreground="#FFEAA7" FontSize="11" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TransactionCount}" 
                                       Foreground="White" FontSize="20" FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </UniformGrid>

            <!-- Financial Cards -->
            <UniformGrid Grid.Row="1" Rows="1" Columns="2">
                <!-- Loans Given Card -->
                <Border Background="#3d8b5f" CornerRadius="8" Padding="16" Margin="0,0,12,0">
                    <Border.Effect>
                        <DropShadowEffect Color="Black" Opacity="0.3" ShadowDepth="2" BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="ðŸ’°" FontSize="32" VerticalAlignment="Center" Margin="0,0,12,0"/>
                        
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Loans Given (Outstanding)" Foreground="#90EE90" FontSize="11" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TotalLoansGiven, StringFormat='â‚¹{0:N2}'}" 
                                       Foreground="White" FontSize="20" FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Loans Taken Card -->
                <Border Background="#b85450" CornerRadius="8" Padding="16" Margin="0">
                    <Border.Effect>
                        <DropShadowEffect Color="Black" Opacity="0.3" ShadowDepth="2" BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="ðŸ’¸" FontSize="32" VerticalAlignment="Center" Margin="0,0,12,0"/>
                        
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Loans Taken (Outstanding)" Foreground="#FFB6C1" FontSize="11" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TotalLoansTaken, StringFormat='â‚¹{0:N2}'}" 
                                       Foreground="White" FontSize="20" FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </UniformGrid>
        </Grid>

        <!-- Recent Transactions and Low Stock -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Recent Transactions -->
            <materialDesign:Card Grid.Column="0" Margin="0,0,12,0" Style="{StaticResource ModernCard}" Background="#2a2a2a">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Margin="20,20,20,16">
                        <TextBlock Text="Recent Transactions" 
                                 FontSize="22" 
                                 FontWeight="SemiBold"
                                 Foreground="White"/>
                        <TextBlock Text="Latest activity in your factory" 
                                 FontSize="13" 
                                 Foreground="{StaticResource TextSecondary}"
                                 Margin="0,4,0,0"/>
                    </StackPanel>
                    
                    <DataGrid ItemsSource="{Binding RecentTransactions}"
                            AutoGenerateColumns="False"
                            CanUserAddRows="False"
                            IsReadOnly="True"
                            VirtualizingPanel.IsVirtualizing="True"
                            VirtualizingPanel.VirtualizationMode="Recycling"
                            EnableRowVirtualization="True"
                            EnableColumnVirtualization="True"
                            Background="Transparent"
                            RowBackground="#1a1a2e"
                            AlternatingRowBackground="#16213e"
                            BorderThickness="0"
                            GridLinesVisibility="None"
                            HeadersVisibility="Column"
                            SelectionMode="Single"
                            SelectionUnit="FullRow">
                        <DataGrid.ColumnHeaderStyle>
                            <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="FontSize" Value="13"/>
                                <Setter Property="Padding" Value="12,8"/>
                                <Setter Property="BorderThickness" Value="0,0,0,2"/>
                                <Setter Property="BorderBrush" Value="#302b63"/>
                            </Style>
                        </DataGrid.ColumnHeaderStyle>
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow" BasedOn="{StaticResource MaterialDesignDataGridRow}">
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Height" Value="52"/>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background">
                                            <Setter.Value>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0" Opacity="0.3">
                                                    <GradientStop Color="#667eea" Offset="0"/>
                                                    <GradientStop Color="#764ba2" Offset="1"/>
                                                </LinearGradientBrush>
                                            </Setter.Value>
                                        </Setter>
                                    </Trigger>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#1f2b4d"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>
                        <DataGrid.CellStyle>
                            <Style TargetType="DataGridCell" BasedOn="{StaticResource MaterialDesignDataGridCell}">
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Padding" Value="12,0"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Border Background="{TemplateBinding Background}" 
                                                    BorderThickness="0" 
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGrid.CellStyle>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Date" Binding="{Binding TransactionDate, StringFormat=dd/MM/yyyy}" Width="100"/>
                            <DataGridTextColumn Header="Type" Binding="{Binding TransactionType}" Width="90">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Item" Binding="{Binding Item.ItemName}" Width="*">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="FontWeight" Value="Medium"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Party" Binding="{Binding Party.Name}" Width="*"/>
                            <DataGridTextColumn Header="Quantity" Binding="{Binding Quantity, StringFormat=N2}" Width="100"/>
                            <DataGridTextColumn Header="Amount" Binding="{Binding TotalAmount, StringFormat='â‚¹ {0:N2}'}" Width="130">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="FontWeight" Value="Bold"/>
                                        <Setter Property="Foreground" Value="{StaticResource AccentCyan}"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </materialDesign:Card>

            <!-- Stock Levels Chart (Native WPF Version) -->
            <materialDesign:Card Grid.Column="1" Margin="0" Style="{StaticResource ModernCard}" Background="#2a2a2a">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Margin="20,20,20,16" Orientation="Horizontal">
                        <Border Background="#4a90c8" 
                                Width="32" Height="32" CornerRadius="8" 
                                Margin="0,0,12,0">
                            <materialDesign:PackIcon Kind="ChartBar" Width="20" Height="20" 
                                                   Foreground="White" 
                                                   VerticalAlignment="Center" HorizontalAlignment="Center"/>
                        </Border>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Stock Levels" 
                                     FontSize="18" 
                                     FontWeight="SemiBold"
                                     Foreground="White"/>
                            <TextBlock Text="Current inventory status" 
                                     FontSize="12" 
                                     Foreground="{StaticResource TextSecondary}"
                                     Margin="0,2,0,0"/>
                        </StackPanel>
                    </StackPanel>
                    
                    <!-- Native WPF Chart using ItemsControl + ProgressBar -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Margin="20,0,20,20">
                        <ItemsControl ItemsSource="{Binding AllItems}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="0,8" BorderBrush="#3a3a3a" BorderThickness="0,0,0,1">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            
                                            <!-- Item Name and Stock Value -->
                                            <DockPanel Grid.Row="0" Margin="0,0,0,6">
                                                <TextBlock DockPanel.Dock="Left"
                                                         Text="{Binding ItemName}" 
                                                         FontWeight="SemiBold"
                                                         FontSize="13"
                                                         Foreground="White"
                                                         VerticalAlignment="Center"/>
                                                <TextBlock DockPanel.Dock="Right"
                                                         HorizontalAlignment="Right"
                                                         VerticalAlignment="Center">
                                                    <Run Text="{Binding CurrentStock, StringFormat=N0, Mode=OneWay}" 
                                                         FontWeight="Bold"
                                                         FontSize="13"
                                                         Foreground="#4a90c8"/>
                                                    <Run Text=" " />
                                                    <Run Text="{Binding Unit, Mode=OneWay}" 
                                                         Foreground="{StaticResource TextSecondary}"
                                                         FontSize="11"/>
                                                </TextBlock>
                                            </DockPanel>
                                            
                                            <!-- Visual Stock Bar -->
                                            <Border Grid.Row="1" 
                                                   Background="#1a1a1a" 
                                                   CornerRadius="4"
                                                   Height="8">
                                                <Border.Clip>
                                                    <RectangleGeometry RadiusX="4" RadiusY="4">
                                                        <RectangleGeometry.Rect>
                                                            <MultiBinding Converter="{StaticResource StockToRectConverter}">
                                                                <Binding Path="ActualWidth" RelativeSource="{RelativeSource AncestorType=Border}"/>
                                                                <Binding Path="ActualHeight" RelativeSource="{RelativeSource AncestorType=Border}"/>
                                                            </MultiBinding>
                                                        </RectangleGeometry.Rect>
                                                    </RectangleGeometry>
                                                </Border.Clip>
                                                <Grid>
                                                    <Border HorizontalAlignment="Left" CornerRadius="4">
                                                        <Border.Width>
                                                            <MultiBinding Converter="{StaticResource StockBarWidthConverter}">
                                                                <Binding Path="CurrentStock"/>
                                                                <Binding Path="ActualWidth" RelativeSource="{RelativeSource AncestorType=Border, AncestorLevel=2}"/>
                                                            </MultiBinding>
                                                        </Border.Width>
                                                        <Border.Background>
                                                            <MultiBinding Converter="{StaticResource StockLevelColorConverter}">
                                                                <Binding Path="CurrentStock"/>
                                                            </MultiBinding>
                                                        </Border.Background>
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </DockPanel>
            </materialDesign:Card>
        </Grid>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="2" Background="#80000000" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                       Value="0"
                       IsIndeterminate="True"
                       Width="60" Height="60"/>
        </Grid>
        </Grid>
    </Grid>
</UserControl>
