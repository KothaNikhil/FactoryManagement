<UserControl x:Class="FactoryManagement.Views.UsersView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:controls="clr-namespace:FactoryManagement.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="500"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel: User List -->
        <Border Grid.Column="0" Margin="0,0,12,0" Style="{StaticResource FormCard}">
            <DockPanel>
                <!-- Header -->
                <controls:SectionHeader DockPanel.Dock="Top" 
                                      Title="User Management" 
                                      IconKind="AccountGroup" 
                                      IconBackground="{StaticResource Card.Info}" />

                <!-- Search Box -->
                <controls:SearchBox DockPanel.Dock="Top" PlaceholderText="Search users by username or role..." />

                <!-- Pagination Control -->
                <controls:PaginationControl DockPanel.Dock="Bottom"
                    CurrentPage="{Binding CurrentPage, Mode=TwoWay}"
                    TotalPages="{Binding TotalPages}"
                    TotalRecords="{Binding TotalRecords}"
                    CanGoToPreviousPage="{Binding CanGoToPreviousPage}"
                    CanGoToNextPage="{Binding CanGoToNextPage}"
                    FirstPageCommand="{Binding GoToFirstPageCommand}"
                    PreviousPageCommand="{Binding GoToPreviousPageCommand}"
                    NextPageCommand="{Binding GoToNextPageCommand}"
                    LastPageCommand="{Binding GoToLastPageCommand}"
                    Margin="0,16,0,0"/>

                <!-- Users DataGrid -->
                <DataGrid ItemsSource="{Binding PaginatedUsers}" 
                          SelectedItem="{Binding SelectedUser, Mode=TwoWay}" 
                          Style="{StaticResource Section.DataGrid}"
                          KeyboardNavigation.TabNavigation="Once">
                    <DataGrid.ColumnHeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource DataGrid.Header.Standard}"/>
                    </DataGrid.ColumnHeaderStyle>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Username" Binding="{Binding Username}" Width="*" MinWidth="150"/>
                        <DataGridTextColumn Header="Role" Binding="{Binding Role}" Width="*" MinWidth="120"/>
                        
                        <DataGridTemplateColumn Header="Status" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Border CornerRadius="4" 
                                            Padding="8,4" 
                                            HorizontalAlignment="Center"
                                            BorderThickness="1">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="#1A3DAA8F"/>
                                                <Setter Property="BorderBrush" Value="{StaticResource SuccessColor}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsActive}" Value="False">
                                                        <Setter Property="Background" Value="#1AE86B6B"/>
                                                        <Setter Property="BorderBrush" Value="{StaticResource ErrorColor}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <TextBlock FontSize="{StaticResource FontSize.Small}" FontWeight="Medium">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Text" Value="Active"/>
                                                    <Setter Property="Foreground" Value="{StaticResource SuccessColor}"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsActive}" Value="False">
                                                            <Setter Property="Text" Value="Inactive"/>
                                                            <Setter Property="Foreground" Value="{StaticResource ErrorColor}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Border>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        
                        <DataGridTextColumn Header="Created" 
                                            Binding="{Binding CreatedDate, StringFormat='dd/MM/yyyy HH:mm'}" 
                                            Width="150">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="Foreground" Value="Gray"/>
                                    <Setter Property="FontSize" Value="12"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTemplateColumn Header="Actions" Width="120">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <Button Style="{StaticResource DataGrid.EditButton}"
                                              Command="{Binding DataContext.EditUserCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              CommandParameter="{Binding}"
                                              ToolTip="Edit">
                                            <materialDesign:PackIcon Kind="Pencil" Width="16" Height="16"/>
                                        </Button>
                                        <Button Style="{StaticResource DataGrid.EditButton}"
                                              Command="{Binding DataContext.DeleteUserCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              CommandParameter="{Binding}"
                                              ToolTip="Delete"
                                              Margin="4,0,0,0"
                                              Foreground="{StaticResource ErrorColor}">
                                            <materialDesign:PackIcon Kind="Delete" Width="16" Height="16"/>
                                        </Button>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </Border>

        <!-- Right Panel: User Form -->
        <Border Grid.Column="1" Style="{StaticResource FormCard}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- Header -->
                <Border Grid.Row="0" Background="{StaticResource Card.Header}" Padding="15" Margin="-24,-24,-24,20" CornerRadius="8,8,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0" Style="{StaticResource SectionHeader}" Margin="0">
                            <Border Style="{StaticResource IconBadge}" Background="{StaticResource Card.Info}">
                                <materialDesign:PackIcon Kind="AccountEdit" Width="20" Height="20" 
                                                       Foreground="White" 
                                                       VerticalAlignment="Center" HorizontalAlignment="Center"/>
                            </Border>
                            <StackPanel Style="{StaticResource SectionHeader.Content}">
                                <TextBlock>
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock" BasedOn="{StaticResource SectionHeader.Title}">
                                            <Setter Property="Text" Value="Add New User"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsEditing}" Value="True">
                                                    <Setter Property="Text" Value="Edit User"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </StackPanel>
                        
                        <Button Grid.Column="1"
                              Content="+ New"
                              Command="{Binding NewUserCommand}"
                              Style="{StaticResource MaterialDesignFlatButton}"
                              Foreground="{StaticResource AccentCyan}"
                              Height="28"
                              Padding="12,0"
                              FontSize="{StaticResource FontSize.SmallMedium}"
                              FontWeight="SemiBold"
                              ToolTip="Clear the form to add a new user"/>
                    </Grid>
                </Border>
                
                <ScrollViewer Grid.Row="1" Style="{StaticResource Section.ScrollViewer}">
                    <StackPanel>
                        <!-- Username -->
                        <TextBlock Text="Username *" 
                                 Foreground="{StaticResource Text.Label}"
                                 FontSize="{StaticResource FontSize.Small}"
                                 Margin="0,0,0,8"/>
                        <TextBox Text="{Binding Username, UpdateSourceTrigger=PropertyChanged}"
                               materialDesign:HintAssist.Hint="Enter username"
                               Style="{StaticResource TextBox.Standard}"
                               Margin="0,0,0,20"/>

                        <!-- Role -->
                        <TextBlock Text="Role *" 
                                 Foreground="{StaticResource Text.Label}"
                                 FontSize="{StaticResource FontSize.Small}"
                                 Margin="0,0,0,8"/>
                        <TextBox Text="{Binding Role, UpdateSourceTrigger=PropertyChanged}"
                               materialDesign:HintAssist.Hint="Enter user role"
                               Style="{StaticResource TextBox.Standard}"
                               Margin="0,0,0,20"/>

                        <!-- Is Active -->
                        <CheckBox Content="Active User" 
                                  IsChecked="{Binding IsActive}"
                                  Style="{StaticResource MaterialDesignCheckBox}"
                                  Foreground="{StaticResource Text.Primary}"
                                  Margin="0,0,0,30"
                                  FontSize="{StaticResource FontSize.Medium}"/>

                        <!-- Error Message -->
                        <Border Style="{StaticResource InfoBox}" 
                                Background="{StaticResource ErrorMessageBackground}"
                                BorderBrush="{StaticResource Card.Danger}"
                                Visibility="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyToVisibilityConverter}}"
                                Margin="0,0,0,16">
                            <TextBlock Text="{Binding ErrorMessage}"
                                     Foreground="{StaticResource ErrorColor}"
                                     TextWrapping="Wrap"/>
                        </Border>

                        <!-- Action Buttons -->
                        <Button Command="{Binding SaveUserCommand}"
                              Style="{StaticResource Button.Success}"
                              HorizontalAlignment="Stretch"
                              Height="44"
                              FontSize="{StaticResource FontSize.Regular}"
                              FontWeight="SemiBold"
                              IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBooleanConverter}}"
                              ToolTip="Save this user to the database">
                            <TextBlock>
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="SAVE USER"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsEditing}" Value="True">
                                                <Setter Property="Text" Value="UPDATE USER"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Button>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Loading Overlay -->
        <Grid Grid.ColumnSpan="2" Background="{StaticResource LoadingOverlayColor}" 
              Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                       Value="0"
                       IsIndeterminate="True"
                       Width="50" Height="50"/>
        </Grid>
    </Grid>
</UserControl>