<UserControl x:Class="FactoryManagement.Views.FinancialRecordsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:local="clr-namespace:FactoryManagement.Behaviors"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:controls="clr-namespace:FactoryManagement.Controls"
             mc:Ignorable="d"
             d:DesignHeight="800"
             d:DesignWidth="1200">
    <i:Interaction.Triggers>
        <i:EventTrigger EventName="Loaded">
            <i:InvokeCommandAction Command="{Binding LoadedCommand}"/>
        </i:EventTrigger>
    </i:Interaction.Triggers>

    <Grid>
        <materialDesign:Snackbar MessageQueue="{Binding SnackbarMessageQueue}"
                                 HorizontalAlignment="Right"
                                 VerticalAlignment="Bottom"
                                 Margin="0,0,16,16"/>
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Title -->
            <!-- <TextBlock Grid.Row="0" Text="Financial Transactions &amp; Loan Management" 
                       FontSize="24" FontWeight="Bold" Foreground="White" Margin="0,0,0,20"/> -->

            <!-- Summary Cards -->
            <Grid Grid.Row="1"
                  Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Loans Given Card -->
                <Border Grid.Column="0"
                        Background="{StaticResource SummaryCardSuccess}"
                        CornerRadius="8"
                        Padding="16">
                    <Border.Effect>
                        <DropShadowEffect Color="Black"
                                          Opacity="0.3"
                                          ShadowDepth="2"
                                          BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                   Text="ðŸ’°"
                                   FontSize="32"
                                   VerticalAlignment="Center"
                                   Margin="0,0,12,0"/>

                        <StackPanel Grid.Column="1"
                                    VerticalAlignment="Center">
                            <TextBlock Text="Loans Given"
                                       Foreground="{StaticResource LabelSuccess}"
                                       FontSize="11"
                                       Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TotalLoansGiven, StringFormat='â‚¹{0:N2}'}"
                                       Foreground="White"
                                       FontSize="20"
                                       FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Loans Taken Card -->
                <Border Grid.Column="2"
                        Background="{StaticResource SummaryCardDanger}"
                        CornerRadius="8"
                        Padding="16">
                    <Border.Effect>
                        <DropShadowEffect Color="Black"
                                          Opacity="0.3"
                                          ShadowDepth="2"
                                          BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                   Text="ðŸ’¸"
                                   FontSize="32"
                                   VerticalAlignment="Center"
                                   Margin="0,0,12,0"/>

                        <StackPanel Grid.Column="1"
                                    VerticalAlignment="Center">
                            <TextBlock Text="Loans Taken"
                                       Foreground="{StaticResource LabelDanger}"
                                       FontSize="11"
                                       Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TotalLoansTaken, StringFormat='â‚¹{0:N2}'}"
                                       Foreground="White"
                                       FontSize="20"
                                       FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Interest Receivable Card -->
                <Border Grid.Column="4"
                        Background="{StaticResource SummaryCardInfo}"
                        CornerRadius="8"
                        Padding="16">
                    <Border.Effect>
                        <DropShadowEffect Color="Black"
                                          Opacity="0.3"
                                          ShadowDepth="2"
                                          BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                   Text="ðŸ“ˆ"
                                   FontSize="32"
                                   VerticalAlignment="Center"
                                   Margin="0,0,12,0"/>

                        <StackPanel Grid.Column="1"
                                    VerticalAlignment="Center">
                            <TextBlock Text="Interest Receivable"
                                       Foreground="{StaticResource LabelInfo}"
                                       FontSize="11"
                                       Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TotalInterestReceivable, StringFormat='â‚¹{0:N2}'}"
                                       Foreground="White"
                                       FontSize="20"
                                       FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Interest Payable Card -->
                <Border Grid.Column="6"
                        Background="{StaticResource SummaryCardWarning}"
                        CornerRadius="8"
                        Padding="16">
                    <Border.Effect>
                        <DropShadowEffect Color="Black"
                                          Opacity="0.3"
                                          ShadowDepth="2"
                                          BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                   Text="ðŸ“‰"
                                   FontSize="32"
                                   VerticalAlignment="Center"
                                   Margin="0,0,12,0"/>

                        <StackPanel Grid.Column="1"
                                    VerticalAlignment="Center">
                            <TextBlock Text="Interest Payable"
                                       Foreground="{StaticResource LabelWarning}"
                                       FontSize="11"
                                       Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding TotalInterestPayable, StringFormat='â‚¹{0:N2}'}"
                                       Foreground="White"
                                       FontSize="20"
                                       FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <!-- Action Section -->
            <Grid Grid.Row="2"
                  Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="15"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Create New Loan Section -->
                <Border Grid.Column="0"
                        BorderBrush="{StaticResource BorderPrimary}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Background="{StaticResource CardBackground}"
                        Padding="24">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Header -->
                        <controls:SectionHeader Grid.Row="0"
                                                Title="Create New Loan"
                                                Subtitle="Record a new loan transaction"
                                                Icon="âž•"
                                                IconBackground="{StaticResource Card.Info}"/>

                        <!-- Row 1: Party, Type, Amount, Rate, Payment Mode -->
                        <Grid Grid.Row="1"
                              Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Party"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <ComboBox ItemsSource="{Binding Parties}"
                                          SelectedItem="{Binding SelectedParty, Mode=TwoWay}"
                                          DisplayMemberPath="Name"
                                          Style="{StaticResource ComboBox.Standard}"
                                          materialDesign:HintAssist.Hint="Select Party">
                                    <i:Interaction.Behaviors>
                                        <local:SearchableComboBoxBehavior DisplayMemberPath="Name"/>
                                    </i:Interaction.Behaviors>
                                </ComboBox>
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Loan Type"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <ComboBox ItemsSource="{Binding LoanTypes}"
                                          SelectedItem="{Binding SelectedLoanType, Mode=TwoWay}"
                                          Style="{StaticResource ComboBox.Standard}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="4">
                                <TextBlock Text="Amount (â‚¹)"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <TextBox Text="{Binding LoanAmount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         GotFocus="NumericTextBox_GotFocus"
                                         Style="{StaticResource TextBox.Standard}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="6">
                                <TextBlock Text="Rate (% p.a.)"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <TextBox Text="{Binding InterestRate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         GotFocus="NumericTextBox_GotFocus"
                                         Style="{StaticResource TextBox.Standard}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="8">
                                <TextBlock Text="Payment Mode"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <ComboBox ItemsSource="{Binding PaymentModes}"
                                          SelectedItem="{Binding SelectedPaymentModeString, Mode=TwoWay}"
                                          Style="{StaticResource ComboBox.Standard}"/>
                            </StackPanel>
                        </Grid>

                        <!-- Row 2: Start Date, Due Date, Notes, and Create Loan Button -->
                        <Grid Grid.Row="2"
                              Margin="0,0,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="1.2*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="1*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="1.5*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Start Date &amp; Time"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="8"/>
                                        <ColumnDefinition Width="80"/>
                                    </Grid.ColumnDefinitions>
                                    <DatePicker Grid.Column="0"
                                                SelectedDate="{Binding StartDate}"
                                                Style="{StaticResource DatePicker.Standard}"/>
                                    <materialDesign:TimePicker Grid.Column="2"
                                                               SelectedTime="{Binding StartTime}"
                                                               Is24Hours="True"
                                                               WithSeconds="False"
                                                               Style="{StaticResource MaterialDesignFloatingHintTimePicker}"
                                                               materialDesign:HintAssist.Hint="Time"/>
                                </Grid>
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Due Date (Optional)"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <DatePicker SelectedDate="{Binding DueDate}"
                                            Style="{StaticResource DatePicker.Standard}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="4">
                                <TextBlock Text="Notes"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <TextBox Text="{Binding LoanNotes, Mode=TwoWay}"
                                         Style="{StaticResource TextBox.Standard}"/>
                            </StackPanel>

                            <Button Grid.Column="6"
                                    Content="CREATE LOAN"
                                    Command="{Binding CreateLoanCommand}"
                                    Background="{StaticResource ButtonSuccess}"
                                    Foreground="White"
                                    Height="38"
                                    MinWidth="130"
                                    FontSize="12"
                                    FontWeight="SemiBold"
                                    BorderThickness="0"
                                    Cursor="Hand"
                                    VerticalAlignment="Bottom"
                                    ToolTip="Create a new loan with the specified party, amount, and interest rate">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Background"
                                                Value="{StaticResource ButtonSuccess}"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}"
                                                            CornerRadius="6"
                                                            BorderThickness="0">
                                                        <ContentPresenter HorizontalAlignment="Center"
                                                                          VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver"
                                                     Value="True">
                                                <Setter Property="Background"
                                                        Value="{StaticResource SuccessSoft}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Record Payment Section -->
                <Border Grid.Column="2"
                        BorderBrush="{StaticResource BorderPrimary}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Background="{StaticResource CardBackground}"
                        Padding="24">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Header -->
                        <controls:SectionHeader Grid.Row="0"
                                                Title="Record Payment"
                                                Subtitle="Apply payment to selected loan"
                                                Icon="ðŸ’³"
                                                IconBackground="{StaticResource Card.Success}"/>

                        <!-- Row 1: Selected Loan and Outstanding -->
                        <Grid Grid.Row="1"
                              Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Selected Loan"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <Border Background="{StaticResource SecondaryBackground}"
                                        CornerRadius="6"
                                        Padding="12">
                                    <TextBlock Text="{Binding SelectedLoan.Party.Name, TargetNullValue='No loan selected'}"
                                               FontWeight="SemiBold"
                                               Foreground="White"
                                               FontSize="14"
                                               VerticalAlignment="Center"/>
                                </Border>
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Outstanding (â‚¹)"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <Border Background="{StaticResource SecondaryBackground}"
                                        CornerRadius="6"
                                        Padding="12">
                                    <TextBlock Text="{Binding SelectedLoan.TotalOutstanding, StringFormat='{}{0:N2}', TargetNullValue='0.00'}"
                                               Foreground="{StaticResource ErrorColor}"
                                               FontWeight="Bold"
                                               FontSize="14"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Right"/>
                                </Border>
                            </StackPanel>

                            <StackPanel Grid.Column="4">
                                <TextBlock Text="Payment Mode *"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <ComboBox ItemsSource="{Binding PaymentModes}"
                                          SelectedItem="{Binding SelectedPaymentModeString, Mode=TwoWay}"
                                          Style="{StaticResource ComboBox.Standard}"/>
                            </StackPanel>
                        </Grid>

                        <!-- Row 2: Payment Amount and Button -->
                        <Grid Grid.Row="2"
                              Margin="0,0,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Payment Amount (â‚¹)"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                                           Margin="0,0,0,8"/>
                                <TextBox Text="{Binding PaymentAmount, UpdateSourceTrigger=PropertyChanged}"
                                         GotFocus="NumericTextBox_GotFocus"
                                         Style="{StaticResource TextBox.Standard}"/>
                            </StackPanel>

                            <Button Grid.Column="2"
                                    Content="RECORD PAYMENT"
                                    Command="{Binding RecordPaymentCommand}"
                                    Background="{StaticResource ButtonSuccess}"
                                    Foreground="White"
                                    Height="38"
                                    MinWidth="140"
                                    FontSize="12"
                                    FontWeight="SemiBold"
                                    BorderThickness="0"
                                    Cursor="Hand"
                                    VerticalAlignment="Bottom"
                                    ToolTip="Apply this payment to the selected loan. Payment is allocated to interest first, then principal">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Background"
                                                Value="{StaticResource ButtonSuccess}"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}"
                                                            CornerRadius="6"
                                                            BorderThickness="0">
                                                        <ContentPresenter HorizontalAlignment="Center"
                                                                          VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver"
                                                     Value="True">
                                                <Setter Property="Background"
                                                        Value="{StaticResource SuccessSoft}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Grid>
                </Border>
            </Grid>

            <!-- Loans List and Transaction History -->
            <Grid Grid.Row="3">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Loans List -->
                <Border Grid.Column="0"
                        BorderBrush="{StaticResource BorderPrimary}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Background="{StaticResource CardBackground}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Header with Filter -->
                        <Border Grid.Row="0"
                                Background="{StaticResource SecondaryBackground}"
                                Padding="15"
                                BorderBrush="{StaticResource BorderPrimary}"
                                BorderThickness="0,0,0,1">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="200"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0"
                                            Style="{StaticResource SectionHeader}"
                                            Margin="0">
                                    <Border Background="{StaticResource Card.Info}"
                                            Style="{StaticResource IconBadge}">
                                        <TextBlock Text="ðŸ“‹"
                                                   FontSize="20"
                                                   Foreground="White"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"/>
                                    </Border>
                                    <StackPanel Style="{StaticResource SectionHeader.Content}">
                                        <TextBlock Text="All Loans"
                                                   Style="{StaticResource SectionHeader.Title}"/>
                                    </StackPanel>
                                </StackPanel>

                                <ComboBox Grid.Column="2"
                                          ItemsSource="{Binding PartiesForFilter}"
                                          SelectedItem="{Binding FilterParty, Mode=TwoWay}"
                                          DisplayMemberPath="Name"
                                          Style="{StaticResource ComboBox.Standard}"
                                          materialDesign:HintAssist.Hint="Filter by Party"
                                          VerticalAlignment="Center"
                                          ToolTip="Filter loans by party. Select 'All' to show all loans.">
                                    <i:Interaction.Behaviors>
                                        <local:SearchableComboBoxBehavior DisplayMemberPath="Name"/>
                                    </i:Interaction.Behaviors>
                                </ComboBox>

                                <Button Grid.Column="4"
                                        Content="ðŸ“Š Update Interest"
                                        Command="{Binding UpdateInterestCommand}"
                                        Background="{StaticResource ButtonWarning}"
                                        Foreground="White"
                                        Padding="15,5"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        ToolTip="Calculate and add accrued interest to the selected loan based on days elapsed since last calculation. Interest = (Principal Ã— Rate Ã— Days) / (365 Ã— 100)"/>

                                <Button Grid.Column="6"
                                        Content="ðŸ”„ Refresh"
                                        Command="{Binding RefreshCommand}"
                                        Background="{StaticResource ButtonInfo}"
                                        Foreground="White"
                                        Padding="15,5"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        ToolTip="Reload all loan data and refresh the summary cards"/>
                                <Button Grid.Column="8"
                                        Content="â†© Undo Delete"
                                        Command="{Binding UndoDeleteLoanCommand}"
                                        Background="{StaticResource ButtonNeutral}"
                                        Foreground="White"
                                        Padding="15,5"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        ToolTip="Restore the last deleted loan and its transactions"/>
                            </Grid>
                        </Border>

                        <!-- Loans DataGrid -->
                        <DataGrid Grid.Row="1"
                                  Style="{StaticResource Section.DataGrid}"
                                  ItemsSource="{Binding PaginatedLoans}"
                                  SelectedItem="{Binding SelectedLoan}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  SelectionMode="Single"
                                  CanUserAddRows="False"
                                  Background="Transparent"
                                  RowBackground="{StaticResource CardBackground}"
                                  KeyboardNavigation.TabNavigation="Once"
                                  AlternatingRowBackground="{StaticResource SecondaryBackground}"
                                  BorderThickness="0"
                                  GridLinesVisibility="None"
                                  HeadersVisibility="Column"
                                  FontSize="13">
                            <DataGrid.ColumnHeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background"
                                            Value="{StaticResource SecondaryBackground}"/>
                                    <Setter Property="Foreground"
                                            Value="{StaticResource TextPrimary}"/>
                                    <Setter Property="FontWeight"
                                            Value="Bold"/>
                                    <Setter Property="FontSize"
                                            Value="13"/>
                                    <Setter Property="Padding"
                                            Value="10"/>
                                    <Setter Property="BorderThickness"
                                            Value="0,0,1,1"/>
                                    <Setter Property="BorderBrush"
                                            Value="{StaticResource BorderPrimary}"/>
                                </Style>
                            </DataGrid.ColumnHeaderStyle>
                            <DataGrid.Columns>
                                <DataGridTemplateColumn Header="Delete"
                                                        Width="70">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Style="{StaticResource DataGrid.EditButton}"
                                                    ToolTip="Delete Loan"
                                                    Command="{Binding DataContext.DeleteLoanCommand, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                                <TextBlock Text="ðŸ—‘"
                                                           FontSize="14"
                                                           VerticalAlignment="Center"
                                                           HorizontalAlignment="Center"/>
                                            </Button>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Party"
                                                    Binding="{Binding PartyName}"/>
                                <DataGridTextColumn Header="Type"
                                                    Binding="{Binding LoanType}"/>
                                <DataGridTextColumn Header="Original Amount"
                                                    Binding="{Binding OriginalAmount, StringFormat=â‚¹{0:N2}}"/>
                                <DataGridTextColumn Header="Rate %"
                                                    Binding="{Binding InterestRate, StringFormat={}{0:N2}%}"/>
                                <DataGridTextColumn Header="Outstanding"
                                                    Binding="{Binding TotalOutstanding, StringFormat=â‚¹{0:N2}}"/>
                                <DataGridTextColumn Header="Status"
                                                    Binding="{Binding Status}"/>
                                <DataGridTextColumn Header="Start Date"
                                                    Binding="{Binding StartDate, StringFormat='dd-MMM-yyyy HH:mm'}"/>
                                <DataGridTextColumn Header="Due Date"
                                                    Binding="{Binding DueDate, StringFormat='dd-MMM-yyyy'}"
                                                    Width="*"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Date Navigation Control for Loans -->
                        <Border Grid.Row="2"
                                Margin="0,16,0,0"
                                Background="{DynamicResource Card.Primary}"
                                CornerRadius="8"
                                Padding="16,12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Previous Day Button -->
                                <Button Grid.Column="0"
                                        Command="{Binding GoToPreviousLoanDayCommand}"
                                        Style="{StaticResource MaterialDesignIconButton}"
                                        ToolTip="Previous Day"
                                        Margin="0,0,8,0">
                                    <materialDesign:PackIcon Kind="ChevronLeft"
                                                             Width="24"
                                                             Height="24"/>
                                </Button>

                                <!-- Current Date Display -->
                                <StackPanel Grid.Column="1"
                                            Orientation="Horizontal"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center">
                                    <materialDesign:PackIcon Kind="Calendar"
                                                             Width="20"
                                                             Height="20"
                                                             Foreground="{DynamicResource Text.Secondary}"
                                                             VerticalAlignment="Center"
                                                             Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding CurrentLoanDate, StringFormat='MMM dd, yyyy (ddd)'}"
                                               FontSize="14"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource Text.Primary}"
                                               VerticalAlignment="Center"
                                               Margin="0,0,16,0"/>
                                    <Button Content="Today"
                                            Command="{Binding GoToTodayLoanCommand}"
                                            Style="{StaticResource Button.Secondary}"
                                            Padding="12,4"
                                            Height="28"
                                            FontSize="12"/>
                                    <TextBlock Text="{Binding TotalRecordsLoans, StringFormat='({0} loans)'}"
                                               FontSize="12"
                                               Foreground="{DynamicResource Text.Secondary}"
                                               VerticalAlignment="Center"
                                               Margin="12,0,0,0"/>
                                </StackPanel>

                                <!-- Next Day Button -->
                                <Button Grid.Column="2"
                                        Command="{Binding GoToNextLoanDayCommand}"
                                        Style="{StaticResource MaterialDesignIconButton}"
                                        ToolTip="Next Day"
                                        Margin="8,0,0,0">
                                    <materialDesign:PackIcon Kind="ChevronRight"
                                                             Width="24"
                                                             Height="24"/>
                                </Button>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>

                <!-- Transaction History -->
                <Border Grid.Column="2"
                        BorderBrush="#444"
                        BorderThickness="1"
                        CornerRadius="8"
                        Background="#2a2a2a">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0"
                                Background="#1a1a1a"
                                Padding="15"
                                BorderBrush="#444"
                                BorderThickness="0,0,0,1">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0"
                                           Text="ðŸ“œ Transaction History"
                                           FontWeight="Bold"
                                           FontSize="16"
                                           Foreground="White"/>
                                <Button Grid.Column="1"
                                        Content="â†© Undo Delete"
                                        Command="{Binding UndoDeleteFinancialTransactionCommand}"
                                        Background="{StaticResource ButtonNeutral}"
                                        Foreground="White"
                                        Padding="12,4"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        ToolTip="Restore the last deleted transaction"/>
                            </Grid>
                        </Border>

                        <DataGrid Grid.Row="1"
                                  Style="{StaticResource Section.DataGrid}"
                                  ItemsSource="{Binding PaginatedTransactions}"
                                  SelectedItem="{Binding SelectedTransaction}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  CanUserAddRows="False"
                                  Background="Transparent"
                                  RowBackground="#2a2a2a"
                                  AlternatingRowBackground="#333"
                                  KeyboardNavigation.TabNavigation="Once"
                                  BorderThickness="0"
                                  GridLinesVisibility="None"
                                  HeadersVisibility="Column"
                                  FontSize="12">
                            <DataGrid.ColumnHeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background"
                                            Value="#1a1a1a"/>
                                    <Setter Property="Foreground"
                                            Value="#BBB"/>
                                    <Setter Property="FontWeight"
                                            Value="Bold"/>
                                    <Setter Property="FontSize"
                                            Value="12"/>
                                    <Setter Property="Padding"
                                            Value="8"/>
                                    <Setter Property="BorderThickness"
                                            Value="0,0,1,1"/>
                                    <Setter Property="BorderBrush"
                                            Value="#444"/>
                                </Style>
                            </DataGrid.ColumnHeaderStyle>
                            <DataGrid.Columns>
                                <DataGridTemplateColumn Header="Delete"
                                                        Width="70">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Style="{StaticResource DataGrid.EditButton}"
                                                    ToolTip="Delete Entry"
                                                    Command="{Binding DataContext.DeleteFinancialTransactionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                                <TextBlock Text="ðŸ—‘"
                                                           FontSize="14"
                                                           VerticalAlignment="Center"
                                                           HorizontalAlignment="Center"/>
                                            </Button>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Date"
                                                    Binding="{Binding TransactionDate, StringFormat='dd-MMM HH:mm'}"
                                                    Width="100"/>
                                <DataGridTextColumn Header="Type"
                                                    Binding="{Binding TransactionType, Converter={StaticResource EnumToFriendlyStringConverter}}"
                                                    Width="140"/>
                                <DataGridTextColumn Header="Party"
                                                    Binding="{Binding PartyName}"
                                                    Width="120"/>
                                <DataGridTextColumn Header="Amount"
                                                    Binding="{Binding Amount, StringFormat=â‚¹{0:N0}}"
                                                    Width="90"/>
                                <DataGridTextColumn Header="Interest"
                                                    Binding="{Binding InterestAmount, StringFormat=â‚¹{0:N0}}"
                                                    Width="80"/>
                                <DataGridTextColumn Header="Mode"
                                                    Binding="{Binding PaymentMode, Converter={StaticResource EnumToFriendlyStringConverter}}"
                                                    Width="80"/>
                                <DataGridTextColumn Header="Entered By"
                                                    Binding="{Binding User.Username}"
                                                    Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Date Navigation Control -->
                        <Border Grid.Row="2"
                                Margin="0,16,0,0"
                                Background="{DynamicResource Card.Primary}"
                                CornerRadius="8"
                                Padding="16,12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Previous Day Button -->
                                <Button Grid.Column="0"
                                        Command="{Binding GoToPreviousTransactionDayCommand}"
                                        Style="{StaticResource MaterialDesignIconButton}"
                                        ToolTip="Previous Day"
                                        Margin="0,0,8,0">
                                    <materialDesign:PackIcon Kind="ChevronLeft"
                                                             Width="24"
                                                             Height="24"/>
                                </Button>

                                <!-- Current Date Display -->
                                <StackPanel Grid.Column="1"
                                            Orientation="Horizontal"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center">
                                    <materialDesign:PackIcon Kind="Calendar"
                                                             Width="20"
                                                             Height="20"
                                                             Foreground="{DynamicResource Text.Secondary}"
                                                             VerticalAlignment="Center"
                                                             Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding CurrentTransactionDate, StringFormat='MMM dd, yyyy (ddd)'}"
                                               FontSize="14"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource Text.Primary}"
                                               VerticalAlignment="Center"
                                               Margin="0,0,16,0"/>
                                    <Button Content="Today"
                                            Command="{Binding GoToTodayTransactionCommand}"
                                            Style="{StaticResource Button.Secondary}"
                                            Padding="12,4"
                                            Height="28"
                                            FontSize="12"/>
                                    <TextBlock Text="{Binding TotalRecordsTransactions, StringFormat='({0} transactions)'}"
                                               FontSize="12"
                                               Foreground="{DynamicResource Text.Secondary}"
                                               VerticalAlignment="Center"
                                               Margin="12,0,0,0"/>
                                </StackPanel>

                                <!-- Next Day Button -->
                                <Button Grid.Column="2"
                                        Command="{Binding GoToNextTransactionDayCommand}"
                                        Style="{StaticResource MaterialDesignIconButton}"
                                        ToolTip="Next Day"
                                        Margin="8,0,0,0">
                                    <materialDesign:PackIcon Kind="ChevronRight"
                                                             Width="24"
                                                             Height="24"/>
                                </Button>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </Grid>

            <!-- Loading Overlay -->
            <Border Grid.RowSpan="4"
                    Background="#CC000000"
                    Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel VerticalAlignment="Center"
                            HorizontalAlignment="Center">
                    <ProgressBar IsIndeterminate="True"
                                 Width="250"
                                 Height="6"
                                 Foreground="#0275d8"/>
                    <TextBlock Text="Loading..."
                               Foreground="White"
                               FontSize="18"
                               Margin="0,15,0,0"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>

