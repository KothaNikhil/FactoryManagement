<UserControl x:Class="FactoryManagement.Views.NewTransactionView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:local="clr-namespace:FactoryManagement.Behaviors"
             mc:Ignorable="d" 
             d:DesignHeight="900" d:DesignWidth="1000">
    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="3*"/>
        </Grid.ColumnDefinitions>
        
        <!-- Transaction Form -->
        <materialDesign:Card Grid.Column="0" Padding="24" Margin="0,0,16,0" Style="{StaticResource Card.Glass}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
            
            <!-- Header -->
            <Border Grid.Row="0" Background="{StaticResource Card.Header}" Padding="12" Margin="-24,-24,-24,16" CornerRadius="12,12,0,0">
                <StackPanel Style="{StaticResource SectionHeader}" Margin="0">
                    <Border Background="{StaticResource SuccessGradient}" 
                            Style="{StaticResource IconBadge}">
                        <materialDesign:PackIcon Kind="CartPlus" Width="20" Height="20" 
                                               Foreground="White" 
                                               VerticalAlignment="Center" HorizontalAlignment="Center"/>
                    </Border>
                    <StackPanel Style="{StaticResource SectionHeader.Content}">
                        <TextBlock Text="{Binding FormTitle}" 
                                 Style="{StaticResource SectionHeader.Title}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
            
            <!-- Content Grid (scrolls within section) -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <Grid Margin="0,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Row 1: Transaction Type, Item, Party, Quantity (4 columns) -->
                <!-- Transaction Type -->
                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,16">
                    <TextBlock Text="Transaction Type *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <ComboBox ItemsSource="{Binding TransactionTypes}"
                            SelectedItem="{Binding SelectedTransactionTypeString}"
                        Style="{StaticResource ComboBox.Dark}">
                        <i:Interaction.Behaviors>
                            <local:SearchableComboBoxBehavior/>
                        </i:Interaction.Behaviors>
                    </ComboBox>
                </StackPanel>

                <!-- Processing Input Item (visible only for Processing type) -->
                <StackPanel Grid.Row="0" Grid.Column="2" Margin="0,0,0,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Input Material *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"
                             Foreground="#FFA726"/>
                    <ComboBox ItemsSource="{Binding Items}"
                            SelectedItem="{Binding InputItem}"
                        Style="{StaticResource ComboBox.Dark}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ItemName}" FontWeight="Bold"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                        <i:Interaction.Behaviors>
                            <local:SearchableComboBoxBehavior DisplayMemberPath="ItemName"/>
                        </i:Interaction.Behaviors>
                    </ComboBox>
                </StackPanel>

                <!-- Item Selection (label changes for Processing) -->
                <StackPanel Grid.Row="0" Grid.Column="2" Margin="0,0,0,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                    <TextBlock Text="Item *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <ComboBox ItemsSource="{Binding Items}"
                            SelectedItem="{Binding SelectedItem}"
                        Style="{StaticResource ComboBox.Dark}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ItemName}" FontWeight="Bold"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                        <i:Interaction.Behaviors>
                            <local:SearchableComboBoxBehavior DisplayMemberPath="ItemName"/>
                        </i:Interaction.Behaviors>
                    </ComboBox>
                </StackPanel>

                <!-- Party Selection with Add Button -->
                <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,0,16">
                    <TextBlock Text="Party" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ComboBox Grid.Column="0"
                            ItemsSource="{Binding Parties}"
                            SelectedItem="{Binding SelectedParty}"
                            Style="{StaticResource ComboBox.Dark}"
                            Margin="0,0,4,0">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}" ToolTip="{Binding Place}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                            <i:Interaction.Behaviors>
                                <local:SearchableComboBoxBehavior DisplayMemberPath="Name"/>
                            </i:Interaction.Behaviors>
                        </ComboBox>
                        <Button Grid.Column="1"
                            Style="{StaticResource Button.Secondary}"
                            ToolTip="Quickly add a new party"
                            Click="QuickAddPartyButton_Click"
                            Padding="8"
                            Height="40">
                            <materialDesign:PackIcon Kind="Plus" Width="16" Height="16"/>
                        </Button>
                    </Grid>
                </StackPanel>

                <!-- Transaction Date -->
                <StackPanel Grid.Row="1" Grid.Column="2" Margin="0,0,0,16">
                    <TextBlock Text="Transaction Date *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <DatePicker SelectedDate="{Binding TransactionDate}"
                              Style="{StaticResource DatePicker.Dark}"/>
                </StackPanel>

                <!-- Row 2: Price Per Unit, Total Amount, Quantity, Entered By (4 columns) -->
                <!-- Input Quantity (visible only for Processing) -->
                <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,0,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Input Quantity *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"
                             Foreground="#FFA726"/>
                    <TextBox Text="{Binding InputQuantity, UpdateSourceTrigger=PropertyChanged}"
                           Style="{StaticResource TextBox.Dark}"
                           GotFocus="NumericTextBox_GotFocus"/>
                </StackPanel>

                <!-- Output Item (visible only for Processing) -->
                <StackPanel Grid.Row="2" Grid.Column="2" Margin="0,0,0,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Output Item *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"
                             Foreground="{StaticResource AccentCyan}"/>
                    <ComboBox ItemsSource="{Binding Items}"
                            SelectedItem="{Binding SelectedItem}"
                        Style="{StaticResource ComboBox.Dark}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ItemName}" FontWeight="Bold"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                        <i:Interaction.Behaviors>
                            <local:SearchableComboBoxBehavior DisplayMemberPath="ItemName"/>
                        </i:Interaction.Behaviors>
                    </ComboBox>
                </StackPanel>

                <!-- Quantity (visible for non-Processing) -->
                <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,0,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                    <TextBlock Text="Quantity *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <TextBox Text="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}"
                           Style="{StaticResource TextBox.Dark}"
                           GotFocus="NumericTextBox_GotFocus"/>
                </StackPanel>

                <!-- Output Quantity (visible only for Processing) -->
                <StackPanel Grid.Row="3" Grid.Column="0" Margin="0,0,0,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Output Quantity *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"
                             Foreground="{StaticResource AccentCyan}"/>
                    <Grid>
                        <TextBox Text="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}"
                               Style="{StaticResource TextBox.Dark}"
                               GotFocus="NumericTextBox_GotFocus"/>
                        <TextBlock Text="{Binding ConversionRate, StringFormat='({0:N1}%)'}"
                                 HorizontalAlignment="Right"
                                 VerticalAlignment="Center"
                                 Margin="0,0,12,0"
                                 FontSize="11"
                                 Foreground="{StaticResource AccentCyan}"
                                 IsHitTestVisible="False"/>
                    </Grid>
                </StackPanel>

                <!-- Price Per Unit (label changes for Processing) -->
                <StackPanel Grid.Row="2" Grid.Column="2" Margin="0,0,0,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                    <TextBlock Text="Price Per Unit *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <TextBox Text="{Binding PricePerUnit, UpdateSourceTrigger=PropertyChanged}"
                           Style="{StaticResource TextBox.Dark}"
                           GotFocus="NumericTextBox_GotFocus"/>
                </StackPanel>

                <!-- Processing Fee (visible only for Processing) -->
                <StackPanel Grid.Row="3" Grid.Column="2" Margin="0,0,0,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Processing Fee (per unit) *" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <TextBox Text="{Binding PricePerUnit, UpdateSourceTrigger=PropertyChanged}"
                           Style="{StaticResource TextBox.Dark}"
                           GotFocus="NumericTextBox_GotFocus"/>
                </StackPanel>

                <!-- Total Amount (Read-only) -->
                <StackPanel Grid.Row="3" Grid.Column="0" Margin="0,0,0,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                    <TextBlock Text="Total Amount" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <Border Background="{StaticResource Bg.Card}" 
                        BorderBrush="{StaticResource Border.Default}"
                            BorderThickness="0,0,0,2"
                            CornerRadius="4"
                            Padding="12,8"
                            Height="40">
                        <Border.Effect>
                            <DropShadowEffect Color="#00f2fe" Opacity="0.15" ShadowDepth="0" BlurRadius="8"/>
                        </Border.Effect>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <materialDesign:PackIcon Grid.Column="0" Kind="CurrencyInr" 
                                                   Width="18" Height="18"
                                                   Foreground="{StaticResource AccentCyan}"
                                                   VerticalAlignment="Center"
                                                   Margin="0,0,6,0"/>
                            <TextBlock Grid.Column="1"
                                     Text="{Binding TotalAmount, StringFormat={}{0:N2}}"
                                     FontSize="14"
                                     FontWeight="Bold"
                                     Foreground="{StaticResource AccentCyan}"
                                     VerticalAlignment="Center"/>
                        </Grid>
                    </Border>
                </StackPanel>

                <!-- Total Processing Fee (Read-only, visible only for Processing) -->
                <StackPanel Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,0,12,16"
                            Visibility="{Binding IsProcessingMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Total Processing Fee" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <Border Background="{StaticResource Bg.Card}" 
                        BorderBrush="{StaticResource Border.Default}"
                            BorderThickness="0,0,0,2"
                            CornerRadius="4"
                            Padding="12,8"
                            Height="40">
                        <Border.Effect>
                            <DropShadowEffect Color="#00f2fe" Opacity="0.15" ShadowDepth="0" BlurRadius="8"/>
                        </Border.Effect>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <materialDesign:PackIcon Grid.Column="0" Kind="CurrencyInr" 
                                                   Width="18" Height="18"
                                                   Foreground="{StaticResource AccentCyan}"
                                                   VerticalAlignment="Center"
                                                   Margin="0,0,6,0"/>
                            <TextBlock Grid.Column="1"
                                     Text="{Binding TotalAmount, StringFormat={}{0:N2}}"
                                     FontSize="14"
                                     FontWeight="Bold"
                                     Foreground="{StaticResource AccentCyan}"
                                     VerticalAlignment="Center"/>
                        </Grid>
                    </Border>
                </StackPanel>

                <!-- Notes -->
                <StackPanel Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,0,12,0">
                    <TextBlock Text="Notes" 
                             Style="{StaticResource MaterialDesignBody2TextBlock}"
                             Margin="0,0,0,8"/>
                    <TextBox Text="{Binding Notes}"
                        Style="{StaticResource TextBox.Dark}"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         MinLines="1"
                         MaxLines="2"/>
                    <!-- Error/Success Message -->
                    <TextBlock Text="{Binding ErrorMessage}"
                             Foreground="#EF5350"
                             TextWrapping="Wrap"
                             Margin="0,12,0,0"
                             FontSize="12"
                             Visibility="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyToVisibilityConverter}}"/>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Row="6" Grid.Column="0" Grid.ColumnSpan="3" VerticalAlignment="Bottom" Margin="0,16,0,0">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="CLEAR"
                            Command="{Binding ClearFormCommand}"
                            Style="{StaticResource Button.Secondary}"
                            Margin="0,0,8,0"
                            Height="40"
                            Padding="20,0"
                            ToolTip="Clear all fields and start a new transaction"/>
                        <Button Content="{Binding SaveButtonText}"
                            Command="{Binding SaveTransactionCommand}"
                            Style="{StaticResource Button.Primary}"
                            Height="40"
                            Padding="20,0"
                            ToolTip="Save this transaction"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
            </ScrollViewer>

            <!-- Loading Overlay -->
            <Grid Background="#80000000" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" ZIndex="999">
                    <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                               Value="0"
                               IsIndeterminate="True"
                               Width="50" Height="50"/>
                </Grid>
            </Grid>
        </materialDesign:Card>
        
        <!-- Recent Transactions -->
        <materialDesign:Card Grid.Column="1" Padding="24" Style="{StaticResource Card.Glass}" VerticalAlignment="Stretch">
            <DockPanel>
                <!-- Header -->
                <Border DockPanel.Dock="Top" Style="{StaticResource SectionHeader.Prominent}">
                    <Grid Margin="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" Style="{StaticResource SectionHeader}" Margin="0">
                            <Border Style="{StaticResource IconBadge}" Background="{StaticResource Card.Info}">
                                <materialDesign:PackIcon Kind="History" Width="20" Height="20" 
                                                       Foreground="White"
                                                       VerticalAlignment="Center"
                                                       HorizontalAlignment="Center"/>
                            </Border>
                            <StackPanel Style="{StaticResource SectionHeader.Content}">
                                <TextBlock Text="Recent Transactions" 
                                         Style="{StaticResource SectionHeader.Title}"/>
                                <TextBlock Text="Latest activity in your factory - Click to edit" 
                                         Style="{StaticResource SectionHeader.Subtitle}"/>
                            </StackPanel>
                        </StackPanel>
                        <Button Grid.Column="1" Content="↩ Undo Delete" 
                                Command="{Binding UndoDeleteTransactionCommand}"
                                Style="{StaticResource Button.Secondary}"
                                Padding="12,4"/>
                    </Grid>
                </Border>
                
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <DataGrid ItemsSource="{Binding RecentTransactions}" 
                              Style="{StaticResource DataGrid.Dark}"
                              MaxHeight="2000"
                              VerticalScrollBarVisibility="Disabled">
                    <DataGrid.ColumnHeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource DataGrid.Header.Standard}"/>
                    </DataGrid.ColumnHeaderStyle>
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="Delete" Width="70">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource DataGrid.EditButton}"
                                            ToolTip="Delete Transaction"
                                            Command="{Binding DataContext.DeleteTransactionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}">
                                        <materialDesign:PackIcon Kind="DeleteForever" Width="16" Height="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Edit" Width="70">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource DataGrid.EditButton}"
                                            ToolTip="Edit Transaction"
                                            Command="{Binding DataContext.EditTransactionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}">
                                        <materialDesign:PackIcon Kind="Pencil" Width="16" Height="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Date" Binding="{Binding TransactionDate, StringFormat=dd/MM/yyyy}" Width="100"/>
                        <DataGridTextColumn Header="Type" Binding="{Binding TransactionType, Converter={StaticResource EnumToFriendlyStringConverter}}" Width="100"/>
                        <DataGridTextColumn Header="Item" Binding="{Binding Item.ItemName}" Width="*"/>
                        <DataGridTextColumn Header="Party" Binding="{Binding Party.Name}" Width="*"/>
                        <DataGridTextColumn Header="Quantity" Binding="{Binding Quantity, StringFormat=N2}" Width="100"/>
                        <DataGridTextColumn Header="Amount" Binding="{Binding TotalAmount, StringFormat='₹ {0:N2}'}" Width="130"/>
                        <DataGridTextColumn Header="Entered By" Binding="{Binding User.Username}" Width="100"/>
                    </DataGrid.Columns>
                    </DataGrid>
                </ScrollViewer>
            </DockPanel>
        </materialDesign:Card>
        <materialDesign:Snackbar MessageQueue="{Binding SnackbarMessageQueue}" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,16,16"/>
    </Grid>
</UserControl>
