<UserControl x:Class="FactoryManagement.Views.TransactionEntryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="1.3*"/>
        </Grid.ColumnDefinitions>
        
        <!-- Transaction Form -->
        <materialDesign:Card Grid.Column="0" Padding="32" Margin="0,0,12,0" Style="{StaticResource Card.Glass}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- Header -->
            <Border Grid.Row="0" Background="{StaticResource Card.Header}" Padding="15" Margin="-32,-32,-32,20" CornerRadius="12,12,0,0">
                <StackPanel Style="{StaticResource SectionHeader}" Margin="0">
                    <Border Background="{StaticResource SuccessGradient}" 
                            Style="{StaticResource IconBadge}">
                        <materialDesign:PackIcon Kind="CartPlus" Width="20" Height="20" 
                                               Foreground="White" 
                                               VerticalAlignment="Center" HorizontalAlignment="Center"/>
                    </Border>
                    <StackPanel Style="{StaticResource SectionHeader.Content}">
                        <TextBlock Text="{Binding FormTitle}" 
                                 Style="{StaticResource SectionHeader.Title}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
            
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel MaxWidth="600">

                <!-- Transaction Type -->
                <TextBlock Text="Transaction Type *" 
                         Style="{StaticResource MaterialDesignBody2TextBlock}"
                         Margin="0,0,0,8"/>
                <ComboBox ItemsSource="{Binding TransactionTypes}"
                        SelectedItem="{Binding SelectedTransactionTypeString}"
                    Style="{StaticResource ComboBox.Dark}"
                        Margin="0,0,0,20"/>

                <!-- Item Selection -->
                <TextBlock Text="Item *" 
                         Style="{StaticResource MaterialDesignBody2TextBlock}"
                         Margin="0,0,0,8"/>
                <ComboBox ItemsSource="{Binding Items}"
                        SelectedItem="{Binding SelectedItem}"
                    Style="{StaticResource ComboBox.Dark}"
                        Margin="0,0,0,20">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel>
                                <TextBlock Text="{Binding ItemName}" FontWeight="Bold"/>
                                <TextBlock Foreground="{StaticResource Text.Secondary}">
                                    <Run Text="Stock: "/>
                                    <Run Text="{Binding CurrentStock, StringFormat=N2}"/>
                                    <Run Text=" "/>
                                    <Run Text="{Binding Unit}"/>
                                </TextBlock>
                            </StackPanel>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <!-- Party Selection -->
                <TextBlock Text="Party" 
                         Style="{StaticResource MaterialDesignBody2TextBlock}"
                         Margin="0,0,0,8"/>
                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                        <ComboBox Grid.Column="0"
                            ItemsSource="{Binding Parties}"
                            SelectedItem="{Binding SelectedParty}"
                            Style="{StaticResource ComboBox.Dark}"
                            Margin="0,0,8,0">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding Place}" Foreground="Gray" Margin="0,0,8,0"/>
                                        <TextBlock Text="-" Foreground="Gray" Margin="0,0,8,0"/>
                                        <TextBlock Text="{Binding MobileNumber}" Foreground="Gray"/>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                      <Button Grid.Column="1"
                          Style="{StaticResource Button.Secondary}"
                          ToolTip="Quickly add a new party without leaving the transaction entry page"
                          Click="QuickAddPartyButton_Click"
                          Padding="8">
                        <materialDesign:PackIcon Kind="Plus" Width="20" Height="20"/>
                    </Button>
                </Grid>

                <!-- Quantity and Price -->
                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Margin="0,0,8,0">
                        <TextBlock Text="Quantity *" 
                                 Style="{StaticResource MaterialDesignBody2TextBlock}"
                                 Margin="0,0,0,8"/>
                           <TextBox Text="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}"
                               Style="{StaticResource TextBox.Dark}"
                               GotFocus="NumericTextBox_GotFocus"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Margin="8,0,0,0">
                        <TextBlock Text="Price Per Unit *" 
                                 Style="{StaticResource MaterialDesignBody2TextBlock}"
                                 Margin="0,0,0,8"/>
                           <TextBox Text="{Binding PricePerUnit, UpdateSourceTrigger=PropertyChanged}"
                               Style="{StaticResource TextBox.Dark}"
                               GotFocus="NumericTextBox_GotFocus"/>
                    </StackPanel>
                </Grid>

                <!-- Total Amount (Read-only) -->
                <TextBlock Text="Total Amount" 
                         Style="{StaticResource MaterialDesignBody2TextBlock}"
                         Margin="0,0,0,8"/>
                <Border Background="{StaticResource Bg.Card}" 
                    BorderBrush="{StaticResource Border.Default}"
                        BorderThickness="0,0,0,2"
                        CornerRadius="4"
                        Padding="16,12"
                        Margin="0,0,0,20">
                    <Border.Effect>
                        <DropShadowEffect Color="#00f2fe" Opacity="0.15" ShadowDepth="0" BlurRadius="8"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <materialDesign:PackIcon Grid.Column="0" Kind="CurrencyInr" 
                                               Width="22" Height="22"
                                               Foreground="{StaticResource AccentCyan}"
                                               VerticalAlignment="Center"
                                               Margin="0,0,12,0"/>
                        <TextBlock Grid.Column="1"
                                 Text="{Binding TotalAmount, StringFormat={}{0:N2}}"
                                 FontSize="20"
                                 FontWeight="Bold"
                                 Foreground="{StaticResource AccentCyan}"
                                 VerticalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- Date and User -->
                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Margin="0,0,8,0">
                        <TextBlock Text="Transaction Date *" 
                                 Style="{StaticResource MaterialDesignBody2TextBlock}"
                                 Margin="0,0,0,8"/>
                        <DatePicker SelectedDate="{Binding TransactionDate}"
                                  Style="{StaticResource DatePicker.Dark}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Margin="8,0,0,0">
                        <TextBlock Text="Entered By *" 
                                 Style="{StaticResource MaterialDesignBody2TextBlock}"
                                 Margin="0,0,0,8"/>
                        <ComboBox ItemsSource="{Binding Users}"
                                SelectedItem="{Binding SelectedUser}"
                                DisplayMemberPath="Username"
                            Style="{StaticResource ComboBox.Dark}"/>
                    </StackPanel>
                </Grid>

                <!-- Notes -->
                <TextBlock Text="Notes" 
                         Style="{StaticResource MaterialDesignBody2TextBlock}"
                         Margin="0,0,0,8"/>
                  <TextBox Text="{Binding Notes}"
                      Style="{StaticResource TextBox.Dark}"
                       AcceptsReturn="True"
                       TextWrapping="Wrap"
                       MinLines="3"
                       Margin="0,0,0,20"/>

                <!-- Error/Success Message -->
                <TextBlock Text="{Binding ErrorMessage}"
                         Foreground="#EF5350"
                         TextWrapping="Wrap"
                         Margin="0,0,0,16"
                         Visibility="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyToVisibilityConverter}}"/>

                <!-- Action Buttons -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
                      <Button Content="CLEAR"
                          Command="{Binding ClearFormCommand}"
                          Style="{StaticResource Button.Secondary}"
                          Margin="0,0,16,0"
                          Height="44"
                          Padding="32,0"
                          ToolTip="Clear all fields and start a new transaction entry"/>
                      <Button Content="{Binding SaveButtonText}"
                          Command="{Binding SaveTransactionCommand}"
                          Style="{StaticResource Button.Primary}"
                          Height="44"
                          Padding="32,0"
                          ToolTip="Save this transaction. The total amount will be calculated automatically from quantity and price per unit"/>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <!-- Loading Overlay -->
        <Grid Background="#80000000" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                       Value="0"
                       IsIndeterminate="True"
                       Width="50" Height="50"/>
        </Grid>
        </Grid>
        </materialDesign:Card>
        
        <!-- Recent Transactions -->
        <materialDesign:Card Grid.Column="1" Padding="24" Style="{StaticResource Card.Glass}">
            <DockPanel>
                <!-- Header -->
                <Border DockPanel.Dock="Top" Style="{StaticResource SectionHeader.Prominent}">
                    <StackPanel Style="{StaticResource SectionHeader}" Margin="0">
                    <Border Style="{StaticResource IconBadge}" Background="{StaticResource Card.Info}">
                        <materialDesign:PackIcon Kind="History" Width="20" Height="20" 
                                               Foreground="White"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center"/>
                    </Border>
                    <StackPanel Style="{StaticResource SectionHeader.Content}">
                        <TextBlock Text="Recent Transactions" 
                                 Style="{StaticResource SectionHeader.Title}"/>
                        <TextBlock Text="Latest activity in your factory - Click to edit" 
                                 Style="{StaticResource SectionHeader.Subtitle}"/>
                    </StackPanel>
                </StackPanel>
                </Border>
                
                <DataGrid ItemsSource="{Binding RecentTransactions}" Style="{StaticResource DataGrid.Dark}">
                    <DataGrid.ColumnHeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource DataGrid.Header.Standard}"/>
                    </DataGrid.ColumnHeaderStyle>
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="Edit" Width="70">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource DataGrid.EditButton}"
                                            ToolTip="Edit Transaction"
                                            Command="{Binding DataContext.EditTransactionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}">
                                        <materialDesign:PackIcon Kind="Pencil" Width="16" Height="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Date" Binding="{Binding TransactionDate, StringFormat=dd/MM/yyyy}" Width="100"/>
                        <DataGridTextColumn Header="Type" Binding="{Binding TransactionType}" Width="90"/>
                        <DataGridTextColumn Header="Item" Binding="{Binding Item.ItemName}" Width="*"/>
                        <DataGridTextColumn Header="Party" Binding="{Binding Party.Name}" Width="*"/>
                        <DataGridTextColumn Header="Quantity" Binding="{Binding Quantity, StringFormat=N2}" Width="100"/>
                        <DataGridTextColumn Header="Amount" Binding="{Binding TotalAmount, StringFormat='â‚¹ {0:N2}'}" Width="130"/>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </materialDesign:Card>
    </Grid>
</UserControl>
